<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>HR Дашборд</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body{font-family:Manrope,sans-serif;background:#f8fafc;color:#1e293b;margin:0;padding:4px;display:flex;flex-direction:column;align-items:center;min-height:100vh;font-size:15px;overflow-x:hidden}
.card{background:#fff;border-radius:16px;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:16px;width:calc(100vw - 24px);margin:12px;box-sizing:border-box}
.header-section{display:flex;flex-direction:column;gap:12px;margin-bottom:20px}
.employee-block,.total-block{background:#fefeff;border-radius:12px;padding:10px;border:none;box-shadow:0 1px 3px rgba(0,0,0,.1);display:flex;flex-direction:column;min-height:130px;justify-content:space-between}
.header{display:flex;align-items:center;gap:10px;margin-bottom:6px}
.avatar{width:48px;height:48px;border-radius:50%;background:#ddd no-repeat center/cover}
.name{font-size:18px;font-weight:600;margin:0;line-height:1.1}
.position{font-size:14px;color:#64748b;margin:3px 0 0;line-height:1.1}
.total-block{display:flex;flex-direction:column;justify-content:space-between}
.metric.no-border.bonus{margin-bottom:3px;position:relative}
.bonus-label,.total-sum{font-size:17px;line-height:1.2;padding-left:4px}
.bonus-row{display:flex;justify-content:space-between;gap:0;padding:3px 0;font-size:14px;position:relative}
.bonus-row::after{content:'';position:absolute;top:0;bottom:0;left:50%;width:1px;background:#e2e8f0}
.bonus-row div{min-width:80px;text-align:center;padding:0 8px}
.period-title{font-size:12px;margin-bottom:6px;display:block}
.bonus-amount{font-size:16px;white-space:nowrap}
.total-row{display:flex;justify-content:center;width:168px;padding:6px 0}
.total-amount{font-size:19px;font-weight:600;white-space:nowrap;line-height:1.2}
.bonus-divider{border-top:1px solid #e2e8f0;margin:3px 0}
.period-select{display:flex;gap:8px;margin-bottom:5px;padding-top:6px;border-top:1px solid #e2e8f0}
select{flex:1;padding:4px 8px;border:none;border-radius:10px;background:#f1f3f6;font-size:13px;text-align:center;font-family:Manrope,sans-serif;outline:none;appearance:auto;-webkit-appearance:auto;-moz-appearance:auto}
select:focus{outline:none;background:#f1f3f6}
.metric{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid #e2e8f0;font-size:15px;line-height:1.2}
.metric.no-border{border-bottom:none}
.oklad-metric{font-size:15px;display:flex;justify-content:space-between;padding-left:4px;line-height:1.2}
.oklad-metric span:last-child{margin-right:8px}
.sprint-container{margin-top:4px}
.sprint-content{display:flex;gap:12px}
.sprint-block-wrapper{flex:1;display:flex;flex-direction:column}
.sprint-title{font-size:14px;font-weight:600;color:#1e293b;text-align:left;margin:0 0 4px 8px;padding:0;align-self:flex-start}
.sprint-block{flex:1;background:#fefeff;border-radius:12px;padding:12px;border:none;box-shadow:0 1px 3px rgba(0,0,0,.1);display:flex;flex-direction:column}
.task-progress-block,.epic-bonus-block{background:#f0f2f6;border-radius:10px;padding:12px;border:none}
.task-progress-block{margin-bottom:8px}
.epic-bonus-block{margin-top:auto}
.epic-bonus-block .metric{padding:4px 0;font-size:14px}
.task-progress-block .metric{font-size:14px}
.progress-bar{height:15px;background:#e2e8f0;border-radius:7.5px;position:relative;margin-top:2px}
.progress-fill{height:100%;background:#674ea6;border-radius:7.5px;position:absolute;top:0;left:0;display:flex;align-items:center;justify-content:center;font-size:11px;color:#fff;min-width:20px}
.loader{position:fixed;top:0;left:0;width:100%;height:100%;background:#f8fafc;backdrop-filter:blur(4px);display:flex;align-items:center;justify-content:center;z-index:100}
.spinner{width:40px;height:40px;border:3px solid #e2e8f0;border-top:3px solid #674ea6;border-radius:50%;animation:spin 1s linear infinite}
.epics-block-wrapper{display:flex;flex-direction:column;margin-bottom:12px}
.epics-title{font-size:14px;font-weight:600;color:#1e293b;text-align:left;margin:0 0 4px 8px;padding:0;align-self:flex-start}
.epics-block{background:#fff;border-radius:12px;padding:12px;border:none;box-shadow:0 1px 3px rgba(0,0,0,.1);display:flex;flex-direction:column}
.epic-item{font-size:13px;color:#1e293b;line-height:1.4;margin:3px 0;text-align:center;border-bottom:1px solid #e2e8f0}
.epic-item:last-child{border-bottom:none}
@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
.content{display:none}
@media (min-width:768px){
.header-section{flex-direction:row;align-items:stretch}
.employee-block,.total-block{flex:1;min-height:150px}
}
@media (max-width:360px){
.card{padding:12px;margin:6px;width:calc(100vw - 12px)}
.header,.period-select{margin-bottom:6px}
.avatar{width:40px;height:40px}
.name{font-size:17px}
.bonus-row div{min-width:60px}
.total-row{width:128px}
.sprint-title,.epics-title{margin-bottom:2px;margin-left:4px}
}
</style>
</head>
<body>
<div class="loader" id="loader"><div class="spinner"></div></div>
<div class="content" id="content">
<div class="card">
<div class="header-section">
<div class="employee-block">
<div class="header">
<div class="avatar" id="avatar"></div>
<div class="info">
<h2 class="name" id="name">А28-Денис</h2>
<p class="position">Аналитик данных</p>
</div>
</div>
<div class="metric no-border oklad-metric"><span>Оклад</span><span id="oklad">-- ₽</span></div>
<div class="period-select">
<select id="monthSelect"></select>
<select id="yearSelect"></select>
</div>
</div>
<div class="total-block">
<div class="metric no-border bonus">
<span class="bonus-label">Бонус</span>
<div class="bonus-row">
<div><span class="period-title">1 период</span><span class="bonus-amount" id="bonus1">-- ₽</span></div>
<div><span class="period-title">2 период</span><span class="bonus-amount" id="bonus2">-- ₽</span></div>
</div>
</div>
<div class="bonus-divider"></div>
<div class="metric no-border">
<span class="total-sum">Выплата</span>
<div class="total-row">
<span class="total-amount" id="total">-- ₽</span>
</div>
</div>
</div>
</div>
<div id="epics-block-wrapper" class="epics-block-wrapper" style="display:none">
<h3 class="epics-title">Закрытые эпики</h3>
<div id="epics-block" class="epics-block">
<div id="epics-list"></div>
</div>
</div>
<div class="sprint-container">
<div class="sprint-content">
<div class="sprint-block-wrapper">
<h3 class="sprint-title">1-й спринт</h3>
<div class="sprint-block">
<div class="task-progress-block">
<div class="metric no-border"><span>Задачи</span><span id="tasks1">--</span></div>
<div class="progress-bar"><div class="progress-fill" id="progressFill1" style="width:0%"></div></div>
</div>
<div class="epic-bonus-block">
<div class="metric no-border"><span>Эпики</span><span id="epics1">--</span></div>
<div class="metric no-border"><span>Бонус</span><span id="sprintBonus1">-- ₽</span></div>
</div>
</div>
</div>
<div class="sprint-block-wrapper">
<h3 class="sprint-title">2-й спринт</h3>
<div class="sprint-block">
<div class="task-progress-block">
<div class="metric no-border"><span>Задачи</span><span id="tasks2">--</span></div>
<div class="progress-bar"><div class="progress-fill" id="progressFill2" style="width:0%"></div></div>
</div>
<div class="epic-bonus-block">
<div class="metric no-border"><span>Эпики</span><span id="epics2">--</span></div>
<div class="metric no-border"><span>Бонус</span><span id="sprintBonus2">-- ₽</span></div>
</div>
</div>
</div>
</div>
</div>
</div>
</body>
<script>
Telegram.WebApp.ready();

// Настройка внешнего вида Telegram Web App
const webApp = Telegram.WebApp;

// Устанавливаем светлую тему для шапки
webApp.setHeaderColor('#ffffff'); // Белый цвет для шапки

// Также можно настроить цвет фона
webApp.setBackgroundColor('#f8fafc'); // Светлый фон как в приложении

// Отключаем темную тему принудительно
webApp.setOptions({
  theme_params: {
    bg_color: '#f8fafc',
    text_color: '#1e293b',
    hint_color: '#64748b',
    link_color: '#674ea6',
    button_color: '#674ea6',
    button_text_color: '#ffffff'
  }
});

// Развертываем на весь экран
webApp.expand();

const user = webApp.initDataUnsafe.user || {};
let allData = {};
const monthsMap = {'январь':1,'февраль':2,'март':3,'апрель':4,'май':5,'июнь':6,'июль':7,'август':8,'сентябрь':9,'октябрь':10,'ноябрь':11,'декабрь':12};
const monthsNames = Object.keys(monthsMap);
const now = new Date();
const currentMonth = monthsNames[now.getMonth()];
const currentYear = now.getFullYear().toString();

document.getElementById('avatar').style.backgroundImage = `url('${user.photo_url || 'https://storage.googleapis.com/hr-avatars-yourproject/default.jpg'}')`;

async function loadAllData() {
  const loader = document.getElementById('loader');
  const content = document.getElementById('content');
  try {
    const response = await fetch('https://mlmotiv.app.n8n.cloud/webhook/data');
    if (!response.ok) throw new Error('Network error');
    allData = await response.json();
    if (!allData || typeof allData !== 'object') throw new Error('Invalid data format');
    
    const years = [...new Set(Object.keys(allData).map(p => p.split('-')[1]))].sort((a, b) => a - b);
    const yearSelect = document.getElementById('yearSelect');
    years.forEach(year => {
      const option = document.createElement('option');
      option.value = year;
      option.textContent = year;
      yearSelect.appendChild(option);
    });
    yearSelect.value = currentYear;
    
    const monthSelect = document.getElementById('monthSelect');
    monthsNames.forEach(month => {
      const option = document.createElement('option');
      option.value = month;
      option.textContent = month.charAt(0).toUpperCase() + month.slice(1);
      monthSelect.appendChild(option);
    });
    monthSelect.value = currentMonth;
    
    updateMetrics(`${monthSelect.value}-${yearSelect.value}`);
  } catch (error) {
    webApp.showAlert('Ошибка загрузки данных. Попробуйте обновить.');
  } finally {
    loader.style.display = 'none';
    content.style.display = 'block';
  }
}

function updateMetrics(period) {
  const data = allData[period] || {};
  const sprint1 = data.sprint1 || {};
  const sprint2 = data.sprint2 || {};
  const formatNum = num => Number.isFinite(num) ? num.toLocaleString('ru-RU') : '--';
  
  document.getElementById('avatar').style.backgroundImage = `url('${data.avatar_url || user.photo_url || 'https://storage.googleapis.com/hr-avatars-yourproject/default.jpg'}')`;
  document.getElementById('oklad').textContent = `${formatNum(data.oklad)} ₽`;
  document.getElementById('tasks1').textContent = `${Number.isFinite(sprint1.tasks_done) ? sprint1.tasks_done : '--'} / ${Number.isFinite(sprint1.total_tasks) ? sprint1.total_tasks : '--'}`;
  document.getElementById('progressFill1').style.width = `${Number.isFinite(sprint1.percent) ? Math.round(sprint1.percent) : 0}%`;
  document.getElementById('progressFill1').textContent = `${Number.isFinite(sprint1.percent) ? Math.round(sprint1.percent) : 0}%`;
  document.getElementById('epics1').textContent = Number.isFinite(sprint1.epics_closed) ? sprint1.epics_closed : '--';
  document.getElementById('sprintBonus1').textContent = `${formatNum(sprint1.bonus)} ₽`;
  document.getElementById('tasks2').textContent = `${Number.isFinite(sprint2.tasks_done) ? sprint2.tasks_done : '--'} / ${Number.isFinite(sprint2.total_tasks) ? sprint2.total_tasks : '--'}`;
  document.getElementById('progressFill2').style.width = `${Number.isFinite(sprint2.percent) ? Math.round(sprint2.percent) : 0}%`;
  document.getElementById('progressFill2').textContent = `${Number.isFinite(sprint2.percent) ? Math.round(sprint2.percent) : 0}%`;
  document.getElementById('epics2').textContent = Number.isFinite(sprint2.epics_closed) ? sprint2.epics_closed : '--';
  document.getElementById('sprintBonus2').textContent = `${formatNum(sprint2.bonus)} ₽`;
  document.getElementById('bonus1').textContent = `${formatNum(sprint1.total_bonus)} ₽`;
  document.getElementById('bonus2').textContent = `${formatNum(sprint2.total_bonus)} ₽`;
  document.getElementById('total').textContent = `${formatNum(data.total)} ₽`;
  
  const epicsWrapper = document.getElementById('epics-block-wrapper');
  const epicsList = document.getElementById('epics-list');
  epicsList.innerHTML = '';
  if (data.epic_names && data.epic_names !== 'нет закрытых эпиков' && data.epic_names.trim()) {
    epicsWrapper.style.display = 'block';
    data.epic_names.split('::').forEach(epic => {
      if (epic.trim()) {
        const div = document.createElement('div');
        div.className = 'epic-item';
        div.textContent = epic.trim();
        epicsList.appendChild(div);
      }
    });
  } else {
    epicsWrapper.style.display = 'none';
  }
}

document.getElementById('monthSelect').addEventListener('change', () => updateMetrics(`${document.getElementById('monthSelect').value}-${document.getElementById('yearSelect').value}`));
document.getElementById('yearSelect').addEventListener('change', () => updateMetrics(`${document.getElementById('monthSelect').value}-${document.getElementById('yearSelect').value}`));

loadAllData();
</script>
</html>
