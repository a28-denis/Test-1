<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HR Дашборд</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --card-gap: min(2vw, 12px);
            --card-padding: min(3vw, 16px);
            --font-base: clamp(13px, 3.5vw, 16px);
            --font-small: clamp(11px, 3vw, 13px);
            --font-xsmall: clamp(10px, 2.5vw, 11px);
        }
        
        body { 
            font-family: 'Manrope', sans-serif; 
            background: #f9f9f9; 
            color: #333; 
            margin: 0; 
            padding: 8px; 
            min-height: 100vh; 
            font-size: var(--font-base);
            overflow-x: hidden; 
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto;
            gap: var(--card-gap);
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .card { 
            background: #fff; 
            border-radius: 12px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1); 
            padding: var(--card-padding);
            border: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }
        
        .employee-block { grid-column: 1; }
        .total-block { grid-column: 2; }
        .sprint-1 { grid-column: 1; grid-row: 2; }
        .sprint-2 { grid-column: 2; grid-row: 2; }
        
        .header { 
            display: flex; 
            align-items: center; 
            gap: min(3vw, 12px); 
            margin-bottom: min(3vw, 12px); 
        }
        
        .avatar { 
            width: min(12vw, 48px); 
            height: min(12vw, 48px); 
            border-radius: 50%; 
            background: #ddd no-repeat center/cover; 
            flex-shrink: 0;
        }
        
        .info { 
            flex: 1;
            min-width: 0;
        }
        
        .name { 
            font-size: var(--font-base); 
            font-weight: 600; 
            margin: 0; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .position { 
            font-size: var(--font-small); 
            color: #666; 
            margin: 2px 0 0; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .metric { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: min(2vw, 8px) 0; 
            border-bottom: 1px solid #eee; 
            font-size: var(--font-small);
        }
        
        .metric.no-border { border-bottom: none; }
        
        .period-select { 
            display: flex; 
            gap: min(2vw, 8px); 
            margin-top: auto;
            border-top: 1px solid #eee;
            padding-top: min(2vw, 8px);
        }
        
        select { 
            flex: 1; 
            padding: min(2vw, 8px) min(1vw, 4px); 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            background: #fff; 
            font-size: var(--font-small); 
            text-align: center; 
            font-family: 'Manrope', sans-serif;
        }
        
        .bonus-row { 
            display: flex; 
            justify-content: space-around; 
            gap: 0;
            padding: min(2vw, 8px) 0;
            position: relative;
        }
        
        .bonus-row::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 1px;
            background: #eee;
            z-index: 1;
        }
        
        .bonus-row div { 
            text-align: center; 
            position: relative;
            z-index: 2;
            flex: 1;
        }
        
        .period-title { 
            font-size: var(--font-xsmall); 
            margin-bottom: min(2vw, 8px); 
            display: block; 
            font-weight: 500; 
            line-height: 1.3; 
        }
        
        .bonus-amount { 
            font-size: var(--font-small); 
            white-space: nowrap; 
        }
        
        .bonus-divider {
            border-top: 1px solid #eee; 
            margin: min(1vw, 4px) 0;
        }
        
        .total-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            margin-top: auto;
            padding-top: min(2vw, 8px);
        }
        
        .total-amount { 
            font-size: var(--font-base); 
            white-space: nowrap; 
            font-weight: 600;
        }
        
        .sprint-title { 
            font-size: var(--font-small); 
            font-weight: 600; 
            color: #333;
            text-align: left;
            margin: 0 0 min(2vw, 8px) 0;
            padding: 0;
        }
        
        .progress-bar { 
            height: min(3vw, 12px); 
            background: #e0e0e0; 
            border-radius: 6px; 
            position: relative; 
            margin-top: min(1vw, 4px); 
        }
        
        .progress-fill { 
            height: 100%; 
            background: #674ea6; 
            border-radius: 6px; 
            position: absolute; 
            top: 0; 
            left: 0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: var(--font-xsmall); 
            color: #fff; 
            min-width: 20px; 
        }
        
        .loader { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: linear-gradient(135deg, #f9f9f9 0%, #e0e0e0 100%); 
            backdrop-filter: blur(4px); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 100; 
        }
        
        .spinner { 
            width: 40px; 
            height: 40px; 
            border: 3px solid #e3f2fd; 
            border-top: 3px solid #674ea6; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .content { display: none; }
        
        @media (prefers-color-scheme: dark) { 
            body { background: #1c1c1e; color: #fff; } 
            .card { background: #2c2c2e; border-color: #555; } 
            .position { color: #aaa; } 
            select { background: #3a3a3c; color: #fff; border-color: #555; } 
            .metric { border-color: #444; } 
            .loader { background: linear-gradient(135deg, #1c1c1e 0%, #2c2c2e 100%); } 
            .spinner { border-color: #3a3a3c; border-top-color: #674ea6; } 
            .progress-bar { background: #555; } 
            .sprint-title { color: #fff; }
            .bonus-divider, .period-select, .bonus-row::after { border-color: #555; background: #555; }
        }
        
        @media (max-width: 480px) {
            .dashboard {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto;
            }
            
            .employee-block { grid-column: 1; grid-row: 1; }
            .total-block { grid-column: 1; grid-row: 2; }
            .sprint-1 { grid-column: 1; grid-row: 3; }
            .sprint-2 { grid-column: 1; grid-row: 4; }
        }
        
        @media (max-width: 320px) {
            :root {
                --card-padding: 12px;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .info {
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="loader" id="loader"><div class="spinner"></div></div>
    <div class="content" id="content">
        <div class="dashboard">
            <div class="card employee-block">
                <div class="header">
                    <div class="avatar" id="avatar"></div>
                    <div class="info">
                        <h2 class="name" id="name">А28-Денис</h2>
                        <p class="position">Аналитик</p>
                    </div>
                </div>
                <div class="metric no-border"><span>Оклад</span><span id="oklad">-- ₽</span></div>
                <div class="period-select">
                    <select id="monthSelect"></select>
                    <select id="yearSelect"></select>
                </div>
            </div>
            
            <div class="card total-block">
                <div class="bonus-row">
                    <div><span class="period-title">Бонус<br>1 период</span><span class="bonus-amount" id="bonus1">-- ₽</span></div>
                    <div><span class="period-title">Бонус<br>2 период</span><span class="bonus-amount" id="bonus2">-- ₽</span></div>
                </div>
                <div class="bonus-divider"></div>
                <div class="total-row">
                    <span class="total-sum">Выплата</span>
                    <span class="total-amount" id="total">-- ₽</span>
                </div>
            </div>
            
            <div class="card sprint-1">
                <h3 class="sprint-title">1-й спринт</h3>
                <div class="metric no-border"><span>Задачи</span><span id="tasks1">--</span></div>
                <div class="progress-bar"><div class="progress-fill" id="progressFill1" style="width: 0%;"></div></div>
                <div class="metric no-border"><span>Эпики</span><span id="epics1">--</span></div>
                <div class="metric no-border"><span>Бонус</span><span id="sprintBonus1">-- ₽</span></div>
            </div>
            
            <div class="card sprint-2">
                <h3 class="sprint-title">2-й спринт</h3>
                <div class="metric no-border"><span>Задачи</span><span id="tasks2">--</span></div>
                <div class="progress-bar"><div class="progress-fill" id="progressFill2" style="width: 0%;"></div></div>
                <div class="metric no-border"><span>Эпики</span><span id="epics2">--</span></div>
                <div class="metric no-border"><span>Бонус</span><span id="sprintBonus2">-- ₽</span></div>
            </div>
        </div>
    </div>

    <script>
        // JavaScript код остается без изменений
        Telegram.WebApp.ready();
        const webApp = Telegram.WebApp;
        const user = webApp.initDataUnsafe.user || {};
        let allData = {};
        const monthsMap = { 'январь': 1, 'февраль': 2, 'март': 3, 'апрель': 4, 'май': 5, 'июнь': 6, 'июль': 7, 'август': 8, 'сентябрь': 9, 'октябрь': 10, 'ноябрь': 11, 'декабрь': 12 };
        const monthsNames = Object.keys(monthsMap);
        const now = new Date();
        const currentMonth = monthsNames[now.getMonth()];
        const currentYear = now.getFullYear().toString();

        document.getElementById('avatar').style.backgroundImage = `url('${user.photo_url || 'https://storage.googleapis.com/hr-avatars-yourproject/default.jpg'}')`;

        async function loadAllData() {
            const loader = document.getElementById('loader');
            const content = document.getElementById('content');
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbxMSaMp8HkUDnKYt9AOR8YEvd3Sg71LydCt4qw8G1RbDL3d2Ujtp9mAbHB-Pvj1t8YB4g/exec');
                if (!response.ok) throw new Error('Network error');
                allData = await response.json();
                if (!allData || typeof allData !== 'object') throw new Error('Invalid data format');

                const years = [...new Set(Object.keys(allData).map(p => p.split('-')[1]))].sort((a, b) => a - b);
                const yearSelect = document.getElementById('yearSelect');
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
                yearSelect.value = currentYear;

                const monthSelect = document.getElementById('monthSelect');
                monthsNames.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = month.charAt(0).toUpperCase() + month.slice(1);
                    monthSelect.appendChild(option);
                });
                monthSelect.value = currentMonth;

                updateMetrics(`${monthSelect.value}-${yearSelect.value}`);
            } catch (error) {
                webApp.showAlert('Ошибка загрузки данных. Попробуйте обновить.');
            } finally {
                loader.style.display = 'none';
                content.style.display = 'block';
            }
        }

        function updateMetrics(period) {
            const data = allData[period] || {};
            const sprint1 = data.sprint1 || {};
            const sprint2 = data.sprint2 || {};
            const formatNum = (num) => Number.isFinite(num) ? num.toLocaleString('ru-RU') : '--';
            
            document.getElementById('avatar').style.backgroundImage = `url('${data.avatar_url || user.photo_url || 'https://storage.googleapis.com/hr-avatars-yourproject/default.jpg'}')`;
            document.getElementById('oklad').textContent = `${formatNum(data.oklad)} ₽`;
            
            document.getElementById('tasks1').textContent = `${Number.isFinite(sprint1.tasks_done) ? sprint1.tasks_done : '--'} / ${Number.isFinite(sprint1.total_tasks) ? sprint1.total_tasks : '--'}`;
            document.getElementById('progressFill1').style.width = `${Number.isFinite(sprint1.percent) ? Math.round(sprint1.percent) : 0}%`;
            document.getElementById('progressFill1').textContent = `${Number.isFinite(sprint1.percent) ? Math.round(sprint1.percent) : 0}%`;
            document.getElementById('epics1').textContent = Number.isFinite(sprint1.epics_closed) ? sprint1.epics_closed : '--';
            document.getElementById('sprintBonus1').textContent = `${formatNum(sprint1.bonus)} ₽`;
            
            document.getElementById('tasks2').textContent = `${Number.isFinite(sprint2.tasks_done) ? sprint2.tasks_done : '--'} / ${Number.isFinite(sprint2.total_tasks) ? sprint2.total_tasks : '--'}`;
            document.getElementById('progressFill2').style.width = `${Number.isFinite(sprint2.percent) ? Math.round(sprint2.percent) : 0}%`;
            document.getElementById('progressFill2').textContent = `${Number.isFinite(sprint2.percent) ? Math.round(sprint2.percent) : 0}%`;
            document.getElementById('epics2').textContent = Number.isFinite(sprint2.epics_closed) ? sprint2.epics_closed : '--';
            document.getElementById('sprintBonus2').textContent = `${formatNum(sprint2.bonus)} ₽`;
            
            document.getElementById('bonus1').textContent = `${formatNum(sprint1.total_bonus)} ₽`;
            document.getElementById('bonus2').textContent = `${formatNum(sprint2.total_bonus)} ₽`;
            
            document.getElementById('total').textContent = `${formatNum(data.total)} ₽`;
        }

        document.getElementById('monthSelect').addEventListener('change', () => updateMetrics(`${document.getElementById('monthSelect').value}-${document.getElementById('yearSelect').value}`));
        document.getElementById('yearSelect').addEventListener('change', () => updateMetrics(`${document.getElementById('monthSelect').value}-${document.getElementById('yearSelect').value}`));
        loadAllData();
    </script>
</body>
</html>
