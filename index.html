<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HR Дашборд</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Manrope', sans-serif; background: #f1f5f9; color: #1e293b; margin: 0; padding: 4px; 
            display: flex; flex-direction: column; align-items: center; min-height: 100vh; font-size: 15px; overflow-x: hidden; }
        .card { background: #ffffff; border-radius: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); padding: 16px; 
            width: calc(100vw - 24px); margin: 12px; box-sizing: border-box; }
        .header-section { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; }
        .employee-block, .total-block { background: #f8fafc; border-radius: 12px; padding: 16px; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .header { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; }
        .avatar { width: 48px; height: 48px; border-radius: 50%; background: #ddd no-repeat center/cover; }
        .name { font-size: 18px; font-weight: 600; margin: 0; }
        .position { font-size: 15px; color: #64748b; margin: 2px 0 0; }
        .total-block { display: flex; flex-direction: column; justify-content: space-between; }
        .metric.no-border.bonus { margin-bottom: 4px; position: relative; }
        .bonus-label, .total-sum { font-size: 17px; }
        .bonus-row { display: flex; justify-content: space-between; gap: 0; padding: 4px 0; font-size: 14px; position: relative; }
        .bonus-row::after { content: ''; position: absolute; top: 0; bottom: 0; left: 50%; width: 1px; background: #e2e8f0; }
        .bonus-row div { min-width: 80px; text-align: center; }
        .period-title { font-size: 12px; margin-bottom: 6px; display: block; }
        .bonus-amount { font-size: 16px; white-space: nowrap; }
        .total-row { display: flex; justify-content: center; width: 168px; padding: 4px 0; }
        .total-amount { font-size: 19px; font-weight: 600; white-space: nowrap; }
        .bonus-divider { border-top: 1px solid #e2e8f0; margin: 4px 0; }
        .period-select { display: flex; gap: 8px; margin-bottom: 6px; padding-top: 8px; border-top: 1px solid #e2e8f0; background: transparent; }
        select { flex: 1; padding: 10px 8px; border: none; border-radius: 12px; background: #ffffff; 
            font-size: 14px; text-align: center; font-family: 'Manrope', sans-serif; outline: none; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2364748b' d='M6 8.825L1.175 4 2.238 2.938 6 6.7l3.763-3.762L10.825 4z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 12px;
        }
        select:focus { outline: none; background: #ffffff; box-shadow: 0 0 0 2px #e2e8f0; }
        .metric { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; 
            border-bottom: 1px solid #e2e8f0; font-size: 15px; }
        .metric.no-border { border-bottom: none; }
        .oklad-metric { font-size: 15px; display: flex; justify-content: space-between; padding-left: 4px; }
        .oklad-metric span:last-child { margin-right: 8px; }
        .sprint-container { margin-top: 4px; }
        .sprint-content { display: flex; gap: 12px; }
        .sprint-block-wrapper { flex: 1; display: flex; flex-direction: column; }
        .sprint-title { font-size: 14px; font-weight: 600; color: #1e293b; text-align: left; margin: 0 0 4px 8px; 
            padding: 0; align-self: flex-start; }
        .sprint-block { flex: 1; background: #f8fafc; border-radius: 12px; padding: 12px; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            display: flex; flex-direction: column; }
        .task-progress-block, .epic-bonus-block { background: #ffffff; border-radius: 10px; padding: 12px; border: none; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .task-progress-block { margin-bottom: 8px; }
        .epic-bonus-block { margin-top: auto; }
        .epic-bonus-block .metric { padding: 5px 0; font-size: 14px; }
        .progress-bar { height: 15px; background: #e2e8f0; border-radius: 7.5px; position: relative; margin-top: 2px; }
        .progress-fill { height: 100%; background: #674ea6; border-radius: 7.5px; position: absolute; top: 0; left: 0; 
            display: flex; align-items: center; justify-content: center; font-size: 11px; color: #fff; min-width: 20px; }
        .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #f1f5f9; backdrop-filter: blur(4px); 
            display: flex; align-items: center; justify-content: center; z-index: 100; }
        .spinner { width: 40px; height: 40px; border: 3px solid #e2e8f0; border-top: 3px solid #674ea6; 
            border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .content { display: none; }
        
        @media (min-width: 768px) {
            .header-section { flex-direction: row; }
            .employee-block, .total-block { flex: 1; height: 100%; }
        }
        
        @media (prefers-color-scheme: dark) { 
            body { background: #0f172a; color: #f1f5f9; } 
            .card { background: #1e293b; box-shadow: 0 2px 8px rgba(0,0,0,0.2); } 
            .position { color: #94a3b8; } 
            select { background: #334155; color: #f1f5f9; border: none; 
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M6 8.825L1.175 4 2.238 2.938 6 6.7l3.763-3.762L10.825 4z'/%3E%3C/svg%3E"); 
                box-shadow: 0 1px 3px rgba(0,0,0,0.2); } 
            select:focus { outline: none; background: #475569; box-shadow: 0 0 0 2px #475569; }
            .metric { border-color: #334155; } 
            .loader { background: #0f172a; } 
            .spinner { border-color: #334155; border-top-color: #674ea6; } 
            .employee-block, .total-block, .sprint-block { background: #1e293b; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.2); } 
            .progress-bar { background: #475569; } 
            .progress-fill { background: #674ea6; } 
            .sprint-title { color: #f1f5f9; }
            .task-progress-block, .epic-bonus-block { background: #334155; border: none; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
            .bonus-divider, .bonus-row::after, .period-select { border-color: #334155; background: #334155; }
            .bonus-label, .total-sum { color: #f1f5f9; }
            .period-title { color: #cbd5e1; }
        }
        
        @media (max-width: 360px) { 
            .card { padding: 12px; margin: 6px; width: calc(100vw - 12px); } 
            .header, .period-select { margin-bottom: 8px; } 
            .avatar { width: 40px; height: 40px; } 
            .name { font-size: 17px; } 
            .bonus-row div { min-width: 60px; }
            .total-row { width: 128px; }
            .sprint-title { margin-bottom: 2px; margin-left: 4px; }
        }
    </style>
</head>
<body>
    <div class="loader" id="loader"><div class="spinner"></div></div>
    <div class="content" id="content">
        <div class="card">
            <div class="header-section">
                <div class="employee-block">
                    <div class="header">
                        <div class="avatar" id="avatar"></div>
                        <div class="info">
                            <h2 class="name" id="name">А28-Денис</h2>
                            <p class="position">Аналитик</p>
                        </div>
                    </div>
                    <div class="metric no-border oklad-metric"><span>Оклад</span><span id="oklad">-- ₽</span></div>
                    <div class="period-select">
                        <select id="monthSelect"></select>
                        <select id="yearSelect"></select>
                    </div>
                </div>
                <div class="total-block">
                    <div class="metric no-border bonus">
                        <span class="bonus-label">Бонус</span>
                        <div class="bonus-row">
                            <div><span class="period-title">1 период</span><span class="bonus-amount" id="bonus1">-- ₽</span></div>
                            <div><span class="period-title">2 период</span><span class="bonus-amount" id="bonus2">-- ₽</span></div>
                        </div>
                    </div>
                    <div class="bonus-divider"></div>
                    <div class="metric no-border">
                        <span class="total-sum">Выплата</span>
                        <div class="total-row">
                            <span class="total-amount" id="total">-- ₽</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="sprint-container">
                <div class="sprint-content">
                    <div class="sprint-block-wrapper">
                        <h3 class="sprint-title">1-й спринт</h3>
                        <div class="sprint-block">
                            <div class="task-progress-block">
                                <div class="metric no-border"><span>Задачи</span><span id="tasks1">--</span></div>
                                <div class="progress-bar"><div class="progress-fill" id="progressFill1" style="width: 0%;"></div></div>
                            </div>
                            <div class="epic-bonus-block">
                                <div class="metric no-border"><span>Эпики</span><span id="epics1">--</span></div>
                                <div class="metric no-border"><span>Бонус</span><span id="sprintBonus1">-- ₽</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="sprint-block-wrapper">
                        <h3 class="sprint-title">2-й спринт</h3>
                        <div class="sprint-block">
                            <div class="task-progress-block">
                                <div class="metric no-border"><span>Задачи</span><span id="tasks2">--</span></div>
                                <div class="progress-bar"><div class="progress-fill" id="progressFill2" style="width: 0%;"></div></div>
                            </div>
                            <div class="epic-bonus-block">
                                <div class="metric no-border"><span>Эпики</span><span id="epics2">--</span></div>
                                <div class="metric no-border"><span>Бонус</span><span id="sprintBonus2">-- ₽</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        Telegram.WebApp.ready();
        const webApp = Telegram.WebApp;
        const user = webApp.initDataUnsafe.user || {};
        let allData = {};
        const monthsMap = { 'январь': 1, 'февраль': 2, 'март': 3, 'апрель': 4, 'май': 5, 'июнь': 6, 'июль': 7, 'август': 8, 'сентябрь': 9, 'октябрь': 10, 'ноябрь': 11, 'декабрь': 12 };
        const monthsNames = Object.keys(monthsMap);
        const now = new Date();
        const currentMonth = monthsNames[now.getMonth()];
        const currentYear = now.getFullYear().toString();

        document.getElementById('avatar').style.backgroundImage = `url('${user.photo_url || 'https://storage.googleapis.com/hr-avatars-yourproject/default.jpg'}')`;

        async function loadAllData() {
            const loader = document.getElementById('loader');
            const content = document.getElementById('content');
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbxMSaMp8HkUDnKYt9AOR8YEvd3Sg71LydCt4qw8G1RbDL3d2Ujtp9mAbHB-Pvj1t8YB4g/exec');
                if (!response.ok) throw new Error('Network error');
                allData = await response.json();
                if (!allData || typeof allData !== 'object') throw new Error('Invalid data format');

                const years = [...new Set(Object.keys(allData).map(p => p.split('-')[1]))].sort((a, b) => a - b);
                const yearSelect = document.getElementById('yearSelect');
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
                yearSelect.value = currentYear;

                const monthSelect = document.getElementById('monthSelect');
                monthsNames.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = month.charAt(0).toUpperCase() + month.slice(1);
                    monthSelect.appendChild(option);
                });
                monthSelect.value = currentMonth;

                updateMetrics(`${monthSelect.value}-${yearSelect.value}`);
            } catch (error) {
                webApp.showAlert('Ошибка загрузки данных. Попробуйте обновить.');
            } finally {
                loader.style.display = 'none';
                content.style.display = 'block';
            }
        }

        function updateMetrics(period) {
            const data = allData[period] || {};
            const sprint1 = data.sprint1 || {};
            const sprint2 = data.sprint2 || {};
            const formatNum = (num) => Number.isFinite(num) ? num.toLocaleString('ru-RU') : '--';
            
            document.getElementById('avatar').style.backgroundImage = `url('${data.avatar_url || user.photo_url || 'https://storage.googleapis.com/hr-avatars-yourproject/default.jpg'}')`;
            document.getElementById('oklad').textContent = `${formatNum(data.oklad)} ₽`;
            
            document.getElementById('tasks1').textContent = `${Number.isFinite(sprint1.tasks_done) ? sprint1.tasks_done : '--'} / ${Number.isFinite(sprint1.total_tasks) ? sprint1.total_tasks : '--'}`;
            document.getElementById('progressFill1').style.width = `${Number.isFinite(sprint1.percent) ? Math.round(sprint1.percent) : 0}%`;
            document.getElementById('progressFill1').textContent = `${Number.isFinite(sprint1.percent) ? Math.round(sprint1.percent) : 0}%`;
            document.getElementById('epics1').textContent = Number.isFinite(sprint1.epics_closed) ? sprint1.epics_closed : '--';
            document.getElementById('sprintBonus1').textContent = `${formatNum(sprint1.bonus)} ₽`;
            
            document.getElementById('tasks2').textContent = `${Number.isFinite(sprint2.tasks_done) ? sprint2.tasks_done : '--'} / ${Number.isFinite(sprint2.total_tasks) ? sprint2.total_tasks : '--'}`;
            document.getElementById('progressFill2').style.width = `${Number.isFinite(sprint2.percent) ? Math.round(sprint2.percent) : 0}%`;
            document.getElementById('progressFill2').textContent = `${Number.isFinite(sprint2.percent) ? Math.round(sprint2.percent) : 0}%`;
            document.getElementById('epics2').textContent = Number.isFinite(sprint2.epics_closed) ? sprint2.epics_closed : '--';
            document.getElementById('sprintBonus2').textContent = `${formatNum(sprint2.bonus)} ₽`;
            
            document.getElementById('bonus1').textContent = `${formatNum(sprint1.total_bonus)} ₽`;
            document.getElementById('bonus2').textContent = `${formatNum(sprint2.total_bonus)} ₽`;
            
            document.getElementById('total').textContent = `${formatNum(data.total)} ₽`;
        }

        document.getElementById('monthSelect').addEventListener('change', () => updateMetrics(`${document.getElementById('monthSelect').value}-${document.getElementById('yearSelect').value}`));
        document.getElementById('yearSelect').addEventListener('change', () => updateMetrics(`${document.getElementById('monthSelect').value}-${document.getElementById('yearSelect').value}`));
        loadAllData();
    </script>
</body>
</html>
