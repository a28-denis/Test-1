<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HR Дашборд</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Manrope', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: #f9f9f9; 
            color: #333; 
            margin: 0; 
            padding: 4px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            min-height: 100vh; 
            font-size: 14px; 
            overflow-x: hidden; 
        }
        .card { 
            background: #fff; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            padding: 12px; 
            width: calc(100vw - 24px); 
            margin: 12px; 
            box-sizing: border-box; 
        }
        .header-section { 
            display: flex; 
            gap: 12px; 
            margin-bottom: 20px; 
        }
        .employee-block { 
            flex: 1; 
            background: #f9f9f9; 
            border-radius: 8px; 
            padding: 12px; 
            border: 1px solid #eee; 
        }
        .header { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin-bottom: 12px; 
        }
        .avatar { 
            width: 48px; 
            height: 48px; 
            border-radius: 50%; 
            background: #ddd no-repeat center/cover; 
        }
        .info { 
            flex: 1; 
        }
        .name { 
            font-size: 16px; 
            font-weight: 600; 
            margin: 0; 
        }
        .position { 
            font-size: 14px; 
            color: #666; 
            margin: 4px 0 0; 
        }
        .total-block { 
            flex: 1; 
            background: #f9f9f9; 
            border-radius: 8px; 
            padding: 12px; 
            border: 1px solid #eee; 
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
        }
        .bonus-row { 
            display: flex; 
            justify-content: space-around; 
            gap: 0;
            padding: 4px 0;
            font-size: 14px; 
            position: relative;
        }
        .bonus-row::after {
            content: '';
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 1px;
            background: #eee;
            z-index: 1;
        }
        .bonus-row div { 
            min-width: 80px; 
            text-align: center; 
            position: relative;
            z-index: 2;
        }
        .total-upper-row {
            display: flex;
            justify-content: space-around;
            gap: 0;
            padding: 4px 0;
            font-size: 14px;
        }
        .period-title { 
            font-size: 12px; 
            margin-bottom: 2px; 
            display: block; 
            font-weight: 500;
        }
        .bonus-amount { 
            font-size: 15px; 
            white-space: nowrap; 
        }
        .total-amount { 
            font-size: 15px; 
            white-space: nowrap; 
        }
        .period-select { 
            display: flex; 
            gap: 8px; 
            margin-bottom: 8px; 
            border-top: 1px solid #eee;
            padding-top: 8px;
        }
        select { 
            flex: 1; 
            padding: 8px 4px; 
            border: 1px solid #ddd; 
            border-radius: 8px; 
            background: #fff; 
            font-size: 14px; 
            text-align: center; 
            font-family: 'Manrope', sans-serif;
        }
        .metric { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 9px 0; 
            border-bottom: 1px solid #eee; 
            font-size: 14px; 
        }
        .metric.no-border { 
            border-bottom: none; 
        }
        .oklad-metric {
            font-size: 14px; 
            display: flex;
            justify-content: space-between;
            padding-left: 4px;
        }
        .sprint-container {
            margin-top: 4px;
        }
        .sprint-content {
            display: flex;
            gap: 12px;
        }
        .sprint-block-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .sprint-title { 
            font-size: 14px; 
            font-weight: 600; 
            color: #333;
            text-align: left;
            margin: 0 0 6px 8px;
            padding: 0;
            align-self: flex-start;
        }
        .sprint-block { 
            flex: 1;
            background: #f9f9f9; 
            border-radius: 8px; 
            padding: 6px; 
            border: 1px solid #eee; 
            display: flex;
            flex-direction: column;
        }
        .task-progress-block { 
            background: #fff; 
            border-radius: 8px; 
            padding: 12px; 
            margin-bottom: 9px; 
            border: 1px solid #eee;
        }
        .epic-bonus-block { 
            background: #fff; 
            border-radius: 8px; 
            padding: 12px; 
            border: 1px solid #eee;
            margin-top: auto;
        }
        .progress-bar { 
            height: 12px; 
            background: #e0e0e0; 
            border-radius: 6px; 
            position: relative; 
            margin-top: 4px; 
        }
        .progress-fill { 
            height: 100%; 
            background: #674ea6; 
            border-radius: 6px; 
            position: absolute; 
            top: 0; 
            left: 0; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 13px; 
            color: #fff; 
            min-width: 20px; 
        }
        .bonus-divider {
            border-top: 1px solid #eee; 
            margin: 4px 0;
        }
        .loader { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: linear-gradient(135deg, #f9f9f9 0%, #e0e0e0 100%); 
            backdrop-filter: blur(4px); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 100; 
        }
        .spinner { 
            width: 40px; 
            height: 40px; 
            border: 3px solid #e3f2fd; 
            border-top: 3px solid #674ea6; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 
            0% { transform: rotate(0deg); } 
            100% { transform: rotate(360deg); } 
        }
        .content { 
            display: none; 
        }
        
        @media (prefers-color-scheme: dark) { 
            body { background: #1c1c1e; color: #fff; } 
            .card { background: #2c2c2e; } 
            .position { color: #aaa; } 
            select { background: #3a3a3c; color: #fff; border-color: #555; } 
            .metric { border-color: #444; } 
            .loader { background: linear-gradient(135deg, #1c1c1e 0%, #2c2c2e 100%); } 
            .spinner { border-color: #3a3a3c; border-top-color: #674ea6; } 
            .employee-block, .total-block, .sprint-block { background: #3a3a3c; border-color: #555; } 
            .progress-bar { background: #555; } 
            .progress-fill { background: #674ea6; } 
            .sprint-title { color: #fff; }
            .task-progress-block, .epic-bonus-block { background: #3a3a3c; border-color: #555; }
            .bonus-divider, .bonus-row::after, .period-select { border-color: #555; }
        }
        
        @media (max-width: 360px) { 
            .card { padding: 8px; margin: 6px; width: calc(100vw - 12px); } 
            .header-section, .sprint-content { flex-direction: column; gap: 8px; } 
            .header, .period-select { margin-bottom: 8px; } 
            .avatar { width: 40px; height: 40px; } 
            .name { font-size: 15px; } 
            .bonus-row div { min-width: 60px; }
            .sprint-title { margin-bottom: 4px; margin-left: 4px; }
        }
    </style>
</head>
<body>
    <div class="loader" id="loader">
        <div class="spinner"></div>
    </div>
    <div class="content" id="content">
        <div class="card">
            <div class="header-section">
                <div class="employee-block">
                    <div class="header">
                        <div class="avatar" id="avatar"></div>
                        <div class="info">
                            <h2 class="name" id="name">А28-Денис</h2>
                            <p class="position">Аналитик</p>
                        </div>
                    </div>
                    <div class="metric no-border oklad-metric"><span>Оклад</span><span id="oklad">-- ₽</span></div>
                    <div class="period-select">
                        <select id="monthSelect"></select>
                        <select id="yearSelect"></select>
                    </div>
                </div>
                <div class="total-block">
                    <div class="bonus-row">
                        <div><span class="period-title">Бонус<br>1 период</span><span class="bonus-amount" id="bonus1">-- ₽</span></div>
                        <div><span class="period-title">Бонус<br>2 период</span><span class="bonus-amount" id="bonus2">-- ₽</span></div>
                    </div>
                    <div class="bonus-divider"></div>
                    <div class="total-upper-row">
                        <div style="text-align: center;"><span class="total-sum">Выплата</span></div>
                        <div style="text-align: center;"><span class="total-amount" id="total">-- ₽</span></div>
                    </div>
                </div>
            </div>
            
            <div class="sprint-container">
                <div class="sprint-content">
                    <div class="sprint-block-wrapper">
                        <h3 class="sprint-title">1-й спринт</h3>
                        <div class="sprint-block">
                            <div class="task-progress-block">
                                <div class="metric no-border"><span>Задачи</span><span id="tasks1">--</span></div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill1" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div class="epic-bonus-block">
                                <div class="metric no-border"><span>Эпики</span><span id="epics1">--</span></div>
                                <div class="metric no-border"><span>Бонус</span><span id="sprintBonus1">-- ₽</span></div>
                            </div>
                        </div>
                    </div>
                    <div class="sprint-block-wrapper">
                        <h3 class="sprint-title">2-й спринт</h3>
                        <div class="sprint-block">
                            <div class="task-progress-block">
                                <div class="metric no-border"><span>Задачи</span><span id="tasks2">--</span></div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill2" style="width: 0%;"></div>
                                </div>
                            </div>
                            <div class="epic-bonus-block">
                                <div class="metric no-border"><span>Эпики</span><span id="epics2">--</span></div>
                                <div class="metric no-border"><span>Бонус</span><span id="sprintBonus2">-- ₽</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        Telegram.WebApp.ready();
        const webApp = Telegram.WebApp;
        const user = webApp.initDataUnsafe.user || {};
        let allData = {};

        const monthsMap = { 'январь': 1, 'февраль': 2, 'март': 3, 'апрель': 4, 'май': 5, 'июнь': 6, 'июль': 7, 'август': 8, 'сентябрь': 9, 'октябрь': 10, 'ноябрь': 11, 'декабрь': 12 };
        const monthsNames = Object.keys(monthsMap);

        const now = new Date();
        const currentMonth = monthsNames[now.getMonth()];
        const currentYear = now.getFullYear().toString();

        document.getElementById('avatar').style.backgroundImage = `url('${user.photo_url || 'https://storage.googleapis.com/hr-avatars-yourproject/default.jpg'}')`;

        async function loadAllData() {
            const loader = document.getElementById('loader');
            const content = document.getElementById('content');
            try {
                const response = await fetch('https://script.google.com/macros/s/AKfycbxMSaMp8HkUDnKYt9AOR8YEvd3Sg71LydCt4qw8G1RbDL3d2Ujtp9mAbHB-Pvj1t8YB4g/exec');
                if (!response.ok) throw new Error('Network error');
                allData = await response.json();
                if (!allData || typeof allData !== 'object') throw new Error('Invalid data format');

                const years = [...new Set(Object.keys(allData).map(p => p.split('-')[1]))].sort((a, b) => a - b);
                const yearSelect = document.getElementById('yearSelect');
                years.forEach(year => {
                    const option = document.createElement('option');
                    option.value = year;
                    option.textContent = year;
                    yearSelect.appendChild(option);
                });
                yearSelect.value = currentYear;

                const monthSelect = document.getElementById('monthSelect');
                monthsNames.forEach(month => {
                    const option = document.createElement('option');
                    option.value = month;
                    option.textContent = month.charAt(0).toUpperCase() + month.slice(1);
                    monthSelect.appendChild(option);
                });
                monthSelect.value = currentMonth;

                updateMetrics(`${monthSelect.value}-${yearSelect.value}`);
            } catch (error) {
                webApp.showAlert('Ошибка загрузки данных. Попробуйте обновить.');
            } finally {
                loader.style.display = 'none';
                content.style.display = 'block';
            }
        }

        function updateMetrics(period) {
            const data = allData[period] || {};
            const sprint1 = data.sprint1 || {};
            const sprint2 = data.sprint2 || {};
            const formatNum = (num) => Number.isFinite(num) ? num.toLocaleString('ru-RU') : '--';
            
            document.getElementById('avatar').style.backgroundImage = `url('${data.avatar_url || user.photo_url || 'https://storage.googleapis.com/hr-avatars-yourproject/default.jpg'}')`;
            document.getElementById('oklad').textContent = `${formatNum(data.oklad)} ₽`;
            
            document.getElementById('tasks1').textContent = `${Number.isFinite(sprint1.tasks_done) ? sprint1.tasks_done : '--'} / ${Number.isFinite(sprint1.total_tasks) ? sprint1.total_tasks : '--'}`;
            document.getElementById('progressFill1').style.width = `${Number.isFinite(sprint1.percent) ? Math.round(sprint1.percent) : 0}%`;
            document.getElementById('progressFill1').textContent = `${Number.isFinite(sprint1.percent) ? Math.round(sprint1.percent) : 0}%`;
            document.getElementById('epics1').textContent = Number.isFinite(sprint1.epics_closed) ? sprint1.epics_closed : '--';
            document.getElementById('sprintBonus1').textContent = `${formatNum(sprint1.bonus)} ₽`;
            
            document.getElementById('tasks2').textContent = `${Number.isFinite(sprint2.tasks_done) ? sprint2.tasks_done : '--'} / ${Number.isFinite(sprint2.total_tasks) ? sprint2.total_tasks : '--'}`;
            document.getElementById('progressFill2').style.width = `${Number.isFinite(sprint2.percent) ? Math.round(sprint2.percent) : 0}%`;
            document.getElementById('progressFill2').textContent = `${Number.isFinite(sprint2.percent) ? Math.round(sprint2.percent) : 0}%`;
            document.getElementById('epics2').textContent = Number.isFinite(sprint2.epics_closed) ? sprint2.epics_closed : '--';
            document.getElementById('sprintBonus2').textContent = `${formatNum(sprint2.bonus)} ₽`;
            
            document.getElementById('bonus1').textContent = `${formatNum(sprint1.total_bonus)} ₽`;
            document.getElementById('bonus2').textContent = `${formatNum(sprint2.total_bonus)} ₽`;
            
            document.getElementById('total').textContent = `${formatNum(data.total)} ₽`;
        }

        document.getElementById('monthSelect').addEventListener('change', () => updateMetrics(`${document.getElementById('monthSelect').value}-${document.getElementById('yearSelect').value}`));
        document.getElementById('yearSelect').addEventListener('change', () => updateMetrics(`${document.getElementById('monthSelect').value}-${document.getElementById('yearSelect').value}`));
        loadAllData();
    </script>
</body>
</html>
